<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="llf.llf.mapper.PostMapper">

    <resultMap id="BaseResultMap" type="llf.llf.pojo.Post">
        <id property="id" column="id" jdbcType="INTEGER"/>
        <result property="userId" column="user_id" jdbcType="INTEGER"/>
        <result property="categoryId" column="category_id" jdbcType="INTEGER"/>
        <result property="title" column="title" jdbcType="VARCHAR"/>
        <result property="content" column="content" jdbcType="LONGVARCHAR"/>
        <result property="summary" column="summary" jdbcType="VARCHAR"/>
        <result property="cover" column="cover" jdbcType="VARCHAR"/>
        <result property="status" column="status" jdbcType="TINYINT"/>
        <result property="viewCount" column="view_count" jdbcType="INTEGER"/>
        <result property="likeCount" column="like_count" jdbcType="INTEGER"/>
        <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
        <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
    </resultMap>

    <resultMap id="PostWithAuthorMap" type="llf.llf.pojo.Post" extends="BaseResultMap">
        <association property="author" javaType="llf.llf.pojo.User">
            <id property="id" column="author_id"/>
            <result property="name" column="author_name"/>
            <result property="username" column="author_username"/>
            <result property="avatar" column="author_avatar"/>
        </association>
        <association property="category" javaType="llf.llf.pojo.Category">
            <id property="id" column="category_id"/>
            <result property="name" column="category_name"/>
            <result property="description" column="category_description"/>
        </association>
    </resultMap>

    <sql id="Base_Column_List">
        id, user_id, category_id, title, content, summary, cover, status, view_count, like_count, create_time, update_time
    </sql>

    <insert id="add" parameterType="llf.llf.pojo.Post" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO post (user_id, category_id, title, content, summary, cover, status, create_time, update_time)
        VALUES (#{userId}, #{categoryId}, #{title}, #{content}, #{summary}, #{cover}, #{status}, NOW(), NOW())
    </insert>

    <update id="update" parameterType="llf.llf.pojo.Post">
        UPDATE post SET
            category_id = #{categoryId},
            title = #{title},
            content = #{content},
            summary = #{summary},
            cover = #{cover},
            status = #{status},
            update_time = NOW()
        WHERE id = #{id}
    </update>

    <delete id="deleteById">
        DELETE FROM post WHERE id = #{id}
    </delete>

    <select id="selectAll" resultMap="PostWithAuthorMap">
        SELECT p.*, 
               u.id as author_id, u.name as author_name, u.username as author_username, u.avatar as author_avatar,
               c.name as category_name, c.description as category_description
        FROM post p
        LEFT JOIN user u ON p.user_id = u.id
        LEFT JOIN category c ON p.category_id = c.id
        ORDER BY p.create_time DESC
    </select>

    <select id="selectById" resultMap="PostWithAuthorMap">
        SELECT p.*,
               u.id as author_id, u.name as author_name, u.username as author_username, u.avatar as author_avatar,
               c.name as category_name, c.description as category_description
        FROM post p
        LEFT JOIN user u ON p.user_id = u.id
        LEFT JOIN category c ON p.category_id = c.id
        WHERE p.id = #{id}
    </select>

    <select id="selectByUserId" resultMap="PostWithAuthorMap">
        SELECT p.*,
               u.id as author_id, u.name as author_name, u.username as author_username, u.avatar as author_avatar,
               c.name as category_name, c.description as category_description
        FROM post p
        LEFT JOIN user u ON p.user_id = u.id
        LEFT JOIN category c ON p.category_id = c.id
        WHERE p.user_id = #{userId}
        ORDER BY p.create_time DESC
    </select>

    <select id="selectByCategoryId" resultMap="PostWithAuthorMap">
        SELECT p.*,
               u.id as author_id, u.name as author_name, u.username as author_username, u.avatar as author_avatar,
               c.name as category_name, c.description as category_description
        FROM post p
        LEFT JOIN user u ON p.user_id = u.id
        LEFT JOIN category c ON p.category_id = c.id
        WHERE p.category_id = #{categoryId}
        ORDER BY p.create_time DESC
    </select>

    <select id="selectByStatus" resultMap="PostWithAuthorMap">
        SELECT p.*,
               u.id as author_id, u.name as author_name, u.username as author_username, u.avatar as author_avatar,
               c.name as category_name, c.description as category_description
        FROM post p
        LEFT JOIN user u ON p.user_id = u.id
        LEFT JOIN category c ON p.category_id = c.id
        WHERE p.status = #{status}
        ORDER BY p.create_time DESC
    </select>

    <select id="selectPublishedPosts" resultMap="PostWithAuthorMap">
        SELECT p.*,
               u.id as author_id, u.name as author_name, u.username as author_username, u.avatar as author_avatar,
               c.name as category_name, c.description as category_description
        FROM post p
        LEFT JOIN user u ON p.user_id = u.id
        LEFT JOIN category c ON p.category_id = c.id
        WHERE p.status = 1
        ORDER BY p.create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="countPublishedPosts" resultType="int">
        SELECT COUNT(*) FROM post WHERE status = 1
    </select>

    <!-- 根据标签ID查询文章 -->
    <select id="selectByTagId" resultMap="PostWithAuthorMap">
        SELECT p.*,
               u.id as author_id, u.name as author_name, u.username as author_username, u.avatar as author_avatar,
               c.name as category_name, c.description as category_description
        FROM post p
        LEFT JOIN user u ON p.user_id = u.id
        LEFT JOIN category c ON p.category_id = c.id
        INNER JOIN post_tag pt ON p.id = pt.post_id
        WHERE pt.tag_id = #{tagId} AND p.status = 1
        ORDER BY p.create_time DESC
    </select>

    <!-- 根据标签ID分页查询文章 -->
    <select id="selectByTagIdWithPaging" resultMap="PostWithAuthorMap">
        SELECT p.*,
               u.id as author_id, u.name as author_name, u.username as author_username, u.avatar as author_avatar,
               c.name as category_name, c.description as category_description
        FROM post p
        LEFT JOIN user u ON p.user_id = u.id
        LEFT JOIN category c ON p.category_id = c.id
        INNER JOIN post_tag pt ON p.id = pt.post_id
        WHERE pt.tag_id = #{tagId} AND p.status = 1
        ORDER BY p.create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 统计标签下的文章数量 -->
    <select id="countPostsByTagId" resultType="int">
        SELECT COUNT(*)
        FROM post p
        INNER JOIN post_tag pt ON p.id = pt.post_id
        WHERE pt.tag_id = #{tagId} AND p.status = 1
    </select>

    <!-- 搜索文章 -->
    <select id="searchPosts" resultMap="PostWithAuthorMap">
        SELECT p.*,
               u.id as author_id, u.name as author_name, u.username as author_username, u.avatar as author_avatar,
               c.name as category_name, c.description as category_description
        FROM post p
        LEFT JOIN user u ON p.user_id = u.id
        LEFT JOIN category c ON p.category_id = c.id
        WHERE p.status = 1
        AND (p.title LIKE CONCAT('%', #{keyword}, '%') OR p.content LIKE CONCAT('%', #{keyword}, '%'))
        ORDER BY p.create_time DESC
    </select>

    <!-- 高级搜索文章 -->
    <select id="searchPostsAdvanced" resultMap="PostWithAuthorMap">
        SELECT p.*,
               u.id as author_id, u.name as author_name, u.username as author_username, u.avatar as author_avatar,
               c.name as category_name, c.description as category_description
        FROM post p
        LEFT JOIN user u ON p.user_id = u.id
        LEFT JOIN category c ON p.category_id = c.id
        WHERE p.status = 1
        AND (p.title LIKE CONCAT('%', #{keyword}, '%') OR p.content LIKE CONCAT('%', #{keyword}, '%') OR p.summary LIKE CONCAT('%', #{keyword}, '%'))
        <if test="categoryId != null">
            AND p.category_id = #{categoryId}
        </if>
        <if test="timeRange != null">
            <choose>
                <when test="timeRange == 'week'">
                    AND p.create_time >= DATE_SUB(NOW(), INTERVAL 1 WEEK)
                </when>
                <when test="timeRange == 'month'">
                    AND p.create_time >= DATE_SUB(NOW(), INTERVAL 1 MONTH)
                </when>
                <when test="timeRange == 'year'">
                    AND p.create_time >= DATE_SUB(NOW(), INTERVAL 1 YEAR)
                </when>
            </choose>
        </if>
        <choose>
            <when test="sortBy == 'latest'">
                ORDER BY p.create_time DESC
            </when>
            <when test="sortBy == 'popular'">
                ORDER BY p.view_count DESC, p.create_time DESC
            </when>
            <otherwise>
                ORDER BY
                    CASE
                        WHEN p.title LIKE CONCAT('%', #{keyword}, '%') THEN 1
                        WHEN p.summary LIKE CONCAT('%', #{keyword}, '%') THEN 2
                        ELSE 3
                    END,
                    p.create_time DESC
            </otherwise>
        </choose>
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 统计搜索结果数量 -->
    <select id="countSearchResults" resultType="int">
        SELECT COUNT(*)
        FROM post p
        WHERE p.status = 1
        AND (p.title LIKE CONCAT('%', #{keyword}, '%') OR p.content LIKE CONCAT('%', #{keyword}, '%') OR p.summary LIKE CONCAT('%', #{keyword}, '%'))
        <if test="categoryId != null">
            AND p.category_id = #{categoryId}
        </if>
        <if test="timeRange != null">
            <choose>
                <when test="timeRange == 'week'">
                    AND p.create_time >= DATE_SUB(NOW(), INTERVAL 1 WEEK)
                </when>
                <when test="timeRange == 'month'">
                    AND p.create_time >= DATE_SUB(NOW(), INTERVAL 1 MONTH)
                </when>
                <when test="timeRange == 'year'">
                    AND p.create_time >= DATE_SUB(NOW(), INTERVAL 1 YEAR)
                </when>
            </choose>
        </if>
    </select>

    <!-- 根据分类ID分页查询文章 -->
    <select id="selectByCategoryIdWithPaging" resultMap="PostWithAuthorMap">
        SELECT p.*,
               u.id as author_id, u.name as author_name, u.username as author_username, u.avatar as author_avatar,
               c.name as category_name, c.description as category_description
        FROM post p
        LEFT JOIN user u ON p.user_id = u.id
        LEFT JOIN category c ON p.category_id = c.id
        WHERE p.category_id = #{categoryId} AND p.status = 1
        ORDER BY p.create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 统计分类下的文章数量 -->
    <select id="countPostsByCategoryId" resultType="int">
        SELECT COUNT(*)
        FROM post
        WHERE category_id = #{categoryId} AND status = 1
    </select>

    <!-- 增加阅读量 -->
    <update id="incrementViewCount">
        UPDATE post SET view_count = view_count + 1 WHERE id = #{postId}
    </update>

    <!-- 更新文章点赞数量 -->
    <update id="updateLikeCount">
        UPDATE post SET like_count = #{likeCount} WHERE id = #{postId}
    </update>

</mapper>
